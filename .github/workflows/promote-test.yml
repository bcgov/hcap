# Promotion to test env.
# Trigger with tag push
# Connected with repo environment 'test'
name: OpenShift Deploy/Promotion to Test

on:
  push:
    tags:
      - test

env:
  CLUSTER: https://api.silver.devops.gov.bc.ca:6443
  AUTH_TOKEN: ${{ secrets.AUTH_TOKEN_OCP4 }}
  SA_TOKEN: ${{ secrets.SA_TOKEN_CONFIG }}
  PROJECT: hcap

jobs:
  test:
    name: Test Config
    runs-on: 'ubuntu-latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            src:
              - 'openshift/**'
          base: 'refs/tags/test'
      - name: Dry run - Test
        env:
          OS_NAMESPACE_SUFFIX: test
        if: steps.changes.outputs.src == 'true'
        run: |
          oc login --token="$SA_TOKEN" --server="$CLUSTER"
          cd "$GITHUB_WORKSPACE"
          make server-config-test
  confirm:
    name: Get Confirmation For Test Deployment
    runs-on: ubuntu-latest
    needs:
      - test
    environment:
      name: test
    steps:
      - name: Log Confirm
        run: echo Workflow approved
  config:
    name: Deploy Config (Test)
    runs-on: ubuntu-latest
    needs: confirm
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            src:
              - 'openshift/**'
          base: 'refs/tags/test'
      - name: Apply Changes
        env:
          OS_NAMESPACE_SUFFIX: test
        if: steps.changes.outputs.src == 'true'
        run: |
          oc login --token="$SA_TOKEN" --server="$CLUSTER"
          cd "$GITHUB_WORKSPACE"
          make server-config
  promoteTest:
    name: OpenShift Promotion
    runs-on: ubuntu-latest
    needs: confirm
    concurrency: ci-promote-test
    timeout-minutes: 6
    env:
      OS_NAMESPACE_SUFFIX: test
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Cache OpenShift CLI
        id: cache-oc
        uses: actions/cache@v2
        with:
          path: /usr/local/bin/oc
          key: ${{ runner.os }}-oc

      - name: Install OpenShift CLI
        if: steps.cache-oc.outputs.cache-hit != 'true'
        run: |
          OC_VERSION=3.11.0
          sudo apt-get update
          sudo apt-get -y install wget
          wget --quiet -O oc.tar.gz "https://github.com/openshift/origin/releases/download/v${OC_VERSION}/openshift-origin-client-tools-v${OC_VERSION}-0cbc58b-linux-64bit.tar.gz"
          FILE=$(tar -tf oc.tar.gz | grep '/oc$')
          tar -zxf oc.tar.gz "$FILE"
          sudo mv "$FILE" /usr/local/bin/oc
          rm -rf oc.tar.gz openshift-origin-client-tools-v*

      - name: Promote
        run: |
          cd "$GITHUB_WORKSPACE"
          oc login --token="$AUTH_TOKEN" --server="$CLUSTER"
          export OS_NAMESPACE_SUFFIX=${{ env.OS_NAMESPACE_SUFFIX }}
          make server-deploy

      - name: Set Notification Title
        run: echo "SLACK_TITLE=$(git tag -l --format='%(contents:subject)' test)" >> $GITHUB_ENV

      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: 'Test Deployment Completed :rocket:'

      - name: Microsoft Teams Deploy Card
      - uses: toko-bifrost/ms-teams-deploy-card@master
        if: always()
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
          environment: name of env
          timezone: America/Vancouver
          custom-actions: '|
            - text: View PR
            url: "https://www.google.ca"'
          custom-facts: '|
            - name: GitHub Run ID
            value: ${{ github.run_id}}'

      - name: Microsoft Teams Notification (Generic)
        uses: aliencube/microsoft-teams-actions@v0.8.0
        with:
          webhook_uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
          title: 'Test Deployment Completed ðŸš€'
          summary: 'PR x Promoted to env'
          theme_color: 'FFE600'
          sections: '[
            {
            "activityTitle": "Tara Epp",
            "activitySubtitle": "9/13/2016, 11:46am",
            "activityImage": "https://connectorsdemo.azurewebsites.net/images/MSC12_Oscar_002.jpg",
            "facts": [
            {
            "name": "Ref:",
            "value": "refs/tags/test"
            },
            {
            "name": "Event:",
            "value": "push"
            }
            ],
            "text": "HCAP-1234 | Add details to page for user roles (#1234)"
            }
            ]'
          actions: '[
            {
            "@type": "OpenUri",
            "name": "OpenShift Deploy/Promotion To Test",
            "targets": [
            {
            "os": "default",
            "uri": "http://google.ca"
            }
            ]
            },
            {
            "@type": "OpenUri",
            "name": "Commit",
            "targets": [
            {
            "os": "default",
            "uri": "http://google.ca"
            }
            ]
            }
            ]'
