name: Test application (e2e)

on:
  push:
    tags:
      - cypress

  pull_request:
    branches:
      - master


jobs:
  npm-test:
    name: Tests (e2e)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Make env
        run: |
          cat > .env << EOF
          ${{ secrets.ENVFILE }}
          EOF

      - name: Build & Run Locally
        run: make local-kc-up

      - name: Check localhost
        uses: jtalk/url-health-check-action@v1.5
        with:
          url: http://localhost:4000
          max-attempts: 2
          retry-delay: 60s

      - name: Run Tests - Backend only
        run: make local-server-tests

      - name: Cypress run - Frontend + Backend
        uses: cypress-io/github-action@v2
        with:
          start: make local-kc-up
          wait-on: 'http://localhost:4000'


    # container: node:14-alpine
    # services:
    #   postgres:
    #     image: postgres:13-alpine
    #     env:
    #       POSTGRES_DB: db_test
    #       POSTGRES_USER: admin
    #       POSTGRES_PASSWORD: admin
    #     # Set health checks to wait until postgres has started
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5

    # steps:
    #   - name: Checkout
    #     uses: actions/checkout@v2

    #   - name: NPM Test
    #     working-directory: ./server
    #     env:
    #       POSTGRES_DB: db_test
    #       POSTGRES_USER: admin
    #       POSTGRES_PASSWORD: admin
    #     run: |
    #       npm ci
    #       npm test
